// Part of <https://miracle.systems/p/walkner-maxos> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","backbone.layout","app/broker","app/socket","app/pubsub","./util"],function(e,t,i,s,r,o,n){"use strict";function p(t){var p=this;p.idPrefix=e.uniqueId("v"),p.options=t||{},p.timers={},p.promises=[],e.forEach(p.sections,function(e,t){p.sections[t]="string"!=typeof e||"#"===e?"#"+p.idPrefix+"-"+t:e.replace("#-","#"+p.idPrefix+"-")}),n.defineSandboxedProperty(p,"broker",s),n.defineSandboxedProperty(p,"pubsub",o),n.defineSandboxedProperty(p,"socket",r),i.call(p,t),n.subscribeTopics(p,"broker",p.localTopics,!0),n.subscribeTopics(p,"pubsub",p.remoteTopics,!0)}return n.inherits(p,i),p.prototype.delegateEvents=function(t){if(t||(t=e.result(this,"events")),!t)return this;this.undelegateEvents(),Object.keys(t).forEach(function(i){var s=t[i];if(e.isFunction(s)||(s=this[s]),e.isFunction(s)){var r=i.match(/^(\S+)\s*(.*)$/),o=r[1]+".delegateEvents"+this.cid,n=r[2];""===n?this.$el.on(o,s.bind(this)):(e.isString(this.idPrefix)&&(n=n.replace(/#-/g,"#"+this.idPrefix+"-")),this.$el.on(o,n,s.bind(this)))}},this)},p.prototype.getViews=function(e){return"string"==typeof e&&/^#-/.test(e)&&(e=e.replace("#-","#"+this.idPrefix+"-")),i.prototype.getViews.call(this,e)},p.prototype.setView=function(e,t,s,r){return"string"==typeof e&&/^#-/.test(e)&&(e=e.replace("#-","#"+this.idPrefix+"-")),i.prototype.setView.call(this,e,t,s,r)},p.prototype.cleanup=function(){this.trigger("cleanup",this),this.destroy(),this.cleanupSelect2(),n.cleanupSandboxedProperties(this),e.isObject(this.timers)&&(e.each(this.timers,clearTimeout),this.timers=null),this.cancelRequests()},p.prototype.destroy=function(){},p.prototype.cleanupSelect2=function(){var e=this;this.$(".select2-container").each(function(){e.$("#"+this.id.replace("s2id_","")).select2("destroy")})},p.prototype.beforeRender=function(){},p.prototype.serialize=function(){return{idPrefix:this.idPrefix}},p.prototype.afterRender=function(){},p.prototype.isRendered=function(){return!0===this.hasRendered},p.prototype.isDetached=function(){return!t.contains(document.documentElement,this.el)},p.prototype.ajax=function(e){return this.promised(t.ajax(e))},p.prototype.promised=function(t){if(!t||!e.isFunction(t.abort))return t;this.promises.push(t);var i=this;return t.always(function(){Array.isArray(i.promises)&&i.promises.splice(i.promises.indexOf(t),1)}),t},p.prototype.cancelRequests=function(){this.promises.forEach(function(e){e.abort()}),this.promises=[]},p.prototype.cancelAnimations=function(e,t){this.$el.stop(!1!==e,!1!==t),this.$(":animated").stop(!1!==e,!1!==t)},p.prototype.$id=function(i){var s="#";return e.isString(this.idPrefix)&&(s+=this.idPrefix+"-"),t(s+i)},p});