// Part of <https://miracle.systems/p/walkner-maxos> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/broker","app/socket","app/viewport","app/core/pages/ErrorPage","app/users/pages/LogInFormPage"],function(e,a,r,t,n,i,o){"use strict";var d={};return t.on("user.reload",function(e){d.reload(e)}),t.on("user.deleted",function(){window.location.reload()}),d.data=e.extend(window.GUEST_USER||{},{name:a.bound("core","GUEST_USER_NAME")}),delete window.GUEST_USER,d.noReload=!1,d.reload=function(t){if(!e.isEqual(t,d.data)){var n=d.isLoggedIn();e.isObject(t)&&Object.keys(t).length>0&&(!1===t.loggedIn&&(t.name=a.bound("core","GUEST_USER_NAME")),d.data=t),d.data.privilegesMap=null,d.noReload?d.noReload=!1:r.publish("user.reloaded"),n&&!d.isLoggedIn()?r.publish("user.loggedOut"):!n&&d.isLoggedIn()&&r.publish("user.loggedIn")}},d.isLoggedIn=function(){return!0===d.data.loggedIn},d.getLabel=function(e){return d.data.name?String(d.data.name):d.data.lastName&&d.data.firstName?e?d.data.firstName+" "+d.data.lastName:d.data.lastName+" "+d.data.firstName:d.data.login},d.getInfo=function(){return{id:d.data._id,ip:d.data.ip||d.data.ipAddress||"0.0.0.0",cname:window.COMPUTERNAME,label:d.getLabel()}},d.isAllowedTo=function(e){if(d.data.super)return!0;var a=d.data.privileges,r=(1===arguments.length?[e]:Array.prototype.slice.call(arguments)).map(function(e){return Array.isArray(e)?e:[e]});if(r.length&&d.data.local&&r[0].some(function(e){return"LOCAL"===e}))return!0;if(!a)return!1;var t=d.isLoggedIn();if(!r.length)return t;for(var n=0,i=r.length;n<i;++n){for(var o=r[n],l=0,s=o.length,g=0;g<s;++g){var u=o[g];"USER"===u?l+=t?1:0:/^FN:/.test(u)?l+=d.data.prodFunction===u.substring(3)?1:0:l+=d.hasPrivilege(o[g])?1:0}if(l===s)return!0}return!1},d.auth=function(){var e=Array.prototype.slice.call(arguments);return function(a,r,t){d.isAllowedTo.apply(d,e)?t():d.isLoggedIn()?require(["app/core/pages/ErrorPage"],function(e){n.showPage(new e({model:{code:403,req:a,previousUrl:r}}))}):n.showPage(new o)}},d.hasPrivilege=function(a){return d.data.privilegesMap||(Array.isArray(d.data.privileges)||(d.data.privileges=[]),d.data.privilegesString="|"+d.data.privileges.join("|"),d.data.privilegesMap={},e.forEach(d.data.privileges,function(e){d.data.privilegesMap[e]=!0})),"*"===a.charAt(a.length-1)?-1!==d.data.privilegesString.indexOf("|"+a.substr(0,a.length-1)):!0===d.data.privilegesMap[a]},d.getGuestUserData=function(){return window.GUEST_USER||{id:null,login:"guest",name:a.bound("core","GUEST_USER_NAME"),loggedIn:!1,super:!1,privileges:[]}},d.getRootUserData=function(){return window.ROOT_USER||{id:null,login:"root",name:"root",loggedIn:!0,super:!0,privileges:[]}},window.user=d,d});