// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-hydro project <http://lukasz.walukiewicz.eu/p/walkner-hydro>

define(["underscore","jquery","app/time","app/highcharts","app/core/View","app/data/controller"],function(t,e,i,a,r,s){"use strict";var n={minutely:"minutes",hourly:"hours",daily:"days",monthly:"months"};return r.extend({className:"analytics-charts-chart",initialize:function(){this.onWindowResize=t.debounce(this.resizeChart.bind(this),30),this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:values",this.updateChart),e(window).on("resize."+this.idPrefix,this.onWindowResize)},destroy:function(){e(window).off("."+this.idPrefix),null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.resizeChart()},createOrUpdateChart:function(){this.timers.createOrUpdateChart=null,this.chart?this.updateChart():(this.createChart(),this.isLoading&&this.chart.showLoading())},createChart:function(){var t=this.serializeSeries(),e=this.serializeYAxis();this.chart=new a.Chart({chart:{renderTo:this.el,plotBorderWidth:1},exporting:{enabled:!1},title:{text:""},noData:{},xAxis:{type:"datetime"},yAxis:e,tooltip:{shared:!0,headerFormatter:function(t){return i.format("number"==typeof t?t:t.x,"LL, HH:mm")}},legend:{enabled:!1},plotOptions:{line:{marker:{enabled:!1,states:{hover:{enabled:!0}}},states:{hover:{lineWidthPlus:0}}},column:{borderWidth:0,groupPadding:0,pointPadding:t[0].data.length>31?0:.1}},series:t})},updateChart:function(){this.chart&&(this.chart.destroy(),this.chart=null),this.createChart()},serializeYAxis:function(){var t=s.get(this.model.get("tag")),e={title:!1,decimals:0,opposite:!1,suffix:"",labels:{format:"{value}"}};if(!t)return e;e.labels.format+=t.get("scaleUnit")||"";var i=[e];return this.model.get("deltas").length&&i.push({title:!1,decimals:3,opposite:!0}),i},serializeSeries:function(){var t=s.get(this.model.get("tag")),e=this.model.get("firstTime")||this.model.get("from"),a=n[this.model.get("interval")],r=i.getMoment(e),h=this.model.get("values").map(function(t,e){var i=r.valueOf();return r.add(1,a),[i,t]}),o=[{type:"line",name:t?t.id:"?",data:h,zIndex:2,color:"#E00",tooltipOptions:{valueDecimals:2,valueSuffix:t.get("scaleUnit")||""}}],l=this.model.get("deltas");return l.length&&o.push({yAxis:1,type:"column",name:t?t.id:"?",data:l.map("dMax"===this.model.get("deltaField")?function(t,e){return[h[e][0],t<0?0:t]}:function(t,e){return[h[e][0],t]}),tooltip:{valueDecimals:3}}),o},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.interval=null,this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},resizeChart:function(){this.$el.height(this.calcChartHeight()),this.chart&&this.chart.reflow()},calcChartHeight:function(){return window.innerHeight-e(".hd").outerHeight()-e(".filter-container").outerHeight()-30}})});