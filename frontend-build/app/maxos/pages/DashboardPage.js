// Part of <https://miracle.systems/p/walkner-maxos> licensed under <CC BY-NC-SA 4.0>

define(["app/i18n","app/user","app/viewport","app/core/View","app/data/controller","../views/InfoView","../views/IndicatorsView","../views/MessageView","../views/OrderSelectorView","../templates/dashboard"],function(e,t,i,o,n,s,a,r,d,c){"use strict";return o.extend({template:c,layoutName:"blank",events:{"mousedown .btn[data-parent-action]":function(e){this.startActionTimer(e)},"touchstart .btn[data-parent-action]":function(e){this.startActionTimer(e)},"mouseup .btn[data-parent-action]":function(e){this.stopActionTimer(e)},"touchend .btn[data-parent-action]":function(e){this.stopActionTimer(e)}},initialize:function(){this.actionTimer={action:null,time:null},this.infoView=new s({model:n}),this.indicatorsView=new a({model:n}),this.messageView=new r({model:n}),this.listenTo(this.infoView,"orderSelectRequested",this.onOrderSelectRequested),this.listenTo(this.messageView,"orderSelectRequested",this.onOrderSelectRequested),this.once("afterRender",function(){window.parent!==window&&window.parent.postMessage({type:"ready",app:"maxos"},"*")}),this.setView("#-info",this.infoView),this.setView("#-indicators",this.indicatorsView),this.setView("#-message",this.messageView),this.timers.checkSync=setInterval(this.checkSync.bind(this),1e4)},destroy:function(){document.body.style.overflow="",document.querySelector(".modal").classList.add("fade")},load:function(e){return e(n.load())},serialize:function(){return{idPrefix:this.idPrefix,embedded:window.parent!==window}},afterRender:function(){document.body.style.overflow="hidden",document.querySelector(".modal").classList.remove("fade")},onOrderSelectRequested:function(){var t=new d({model:n});this.listenTo(t,"orderSelected",function(e){i.closeDialog(),n.tags.setValue("program.order",e)}),i.showDialog(t,e("maxos","orderSelector:title"))},startActionTimer:function(e){this.actionTimer.action=e.currentTarget.dataset.parentAction,this.actionTimer.time=Date.now(),e.preventDefault()},stopActionTimer:function(e){var t=e.currentTarget.dataset.parentAction;if(this.actionTimer.action===t){var i=Date.now()-this.actionTimer.time>3e3;"goToResults"===t?window.location.href="#maxos/tests":"switchApps"===t?i?window.parent.postMessage({type:"config"},"*"):window.parent.postMessage({type:"switch",app:"maxos"},"*"):"reboot"===t?i?window.parent.postMessage({type:"reboot"},"*"):window.parent.postMessage({type:"refresh"},"*"):i&&"shutdown"===t&&window.parent.postMessage({type:"shutdown"},"*"),this.actionTimer.action=null,this.actionTimer.time=null}},isReloadNeeded:function(){return this.socket.isConnected()&&!n.tags.getValue("program.message")},checkSync:function(){clearTimeout(this.timers.reload),this.isReloadNeeded()&&(this.timers.reload=setTimeout(this.reloadIfNeeded.bind(this),3333))},reloadIfNeeded:function(){this.isReloadNeeded()&&window.location.reload()}})});