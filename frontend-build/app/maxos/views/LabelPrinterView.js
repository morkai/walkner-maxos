// Part of <https://miracle.systems/p/walkner-maxos> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/views/VkbView","../templates/labelPrinter"],function(e,t,i,s,n,r,o,a,d){"use strict";return o.extend({dialogClassName:"maxos-labelPrinter-dialog",template:d,events:{submit:function(){var e=this;e.vkb.hide(),e.el.classList.add("in-progress"),e.$("input, .btn").prop("disabled",!0);var t=e.ajax({method:"POST",url:"/maxos/printLabels",data:JSON.stringify({orderNo:this.$id("orderNo").val(),items:this.$id("items").val(),kinds:this.$('input[name="kinds"]:checked').map(function(){return this.value}).get()})});return t.fail(function(){var s=t.responseJSON,n=s&&s.error&&s.error;n&&i.has("maxos","labelPrinter:error:"+n.message)||(n={message:"FAILURE"}),r.msg.hide(),r.msg.show({type:t.status>=400&&t.status<500?"warning":"error",time:3e3,text:i("maxos","labelPrinter:error:"+n.message,n)}),e.el.classList.remove("in-progress"),e.$("input, .btn").prop("disabled",!1),e.$id("todo").text(0),e.$id("done").text(0)}),t.done(function(t){e.commId=t.commId,e.$id("todo").text(t.labelCount.toLocaleString())}),!1},"focus [data-vkb]":function(e){this.vkb.show(e.currentTarget,this.onVkbValueChange)},"input [data-vkb]":function(e){this.onVkbValueChange(e.currentTarget),this.$id("submit").prop("disabled",!1).removeClass("btn-success").addClass("btn-primary"),this.$id("todo").text(0),this.$id("done").text(0)},'change [name="kinds"]':function(){this.toggleKinds()},"blur #-items":function(){var e=this.$id("items"),t=e.val().split(/[, ]/).map(function(e){if(e=e.replace(/[^0-9\-]+/g,""),/^[0-9]{1,4}$/.test(e))return e;if(/^[0-9]{1,4}-[0-9]{1,4}$/.test(e)){var t=e.split("-").map(function(e){return+e}),i=t[0],s=t[1];if(i===s)return i;if(i<s)return i+"-"+s}return""}).filter(function(e){return e.length>0});e.val(t.join(","))}},remoteTopics:{"maxos.labels.printed":function(e){this.commId===e.commId&&(this.$id("todo").text(e.todo.toLocaleString()),this.$id("done").text(e.done.toLocaleString()),e.done===e.todo&&(this.commId=null,this.el.classList.remove("in-progress"),this.$("input, .btn-link").prop("disabled",!1),this.$id("submit").removeClass("btn-primary").addClass("btn-success")))}},initialize:function(){this.onVkbValueChange=this.onVkbValueChange.bind(this),this.commId=null,this.vkb=new a},destroy:function(){this.vkb.hide(),this.vkb.remove()},serialize:function(){var e=(this.model.tags.getValue("program.lastSerialNumber")||"").split(".");return{idPrefix:this.idPrefix,orderNo:3===e.length?e[1]:"",items:3===e.length?e[2].replace(/^0+/,""):""}},afterRender:function(){this.vkb.render().$el.appendTo("body");var e=this.$id("submit")[0];this.$id("progressBar").css({top:e.offsetTop+"px",left:e.offsetLeft+"px",width:e.offsetWidth+"px",height:e.offsetHeight+"px"}),this.$id("orderNo").focus()[0].selectionStart=9},onVkbValueChange:function(){},toggleKinds:function(){this.$('[name="kinds"]').prop("required",0===this.$('[name="kinds"]:checked').length)}})});