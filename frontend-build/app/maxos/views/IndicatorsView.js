// Part of <https://miracle.systems/p/walkner-maxos> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/core/Model","app/core/View","../templates/indicators"],function(e,t,a,s,i,o,r,n){"use strict";var g=/^program\.throughWireTest\.([0-9])\.([0-9])$/;return r.extend({template:n,events:{"click .maxos-core":function(e){var t=e.currentTarget,a=+t.dataset.connector;if(a!==this.model.tags.getValue("powerConnector.1")&&a!==this.model.tags.getValue("powerConnector.2")){var s=this.model.tags.get(t.dataset.tag);s&&s.get("writable")&&this.model.tags.setValue(s.id,!s.get("value"))}},"click .maxos-link":function(e){var t=e.currentTarget,a=t.dataset.cable,s=t.dataset.core;this.$('.maxos-core[data-cable="'+a+'"][data-core="'+s+'"]').click()},"click .maxos-connector-label":function(e){var t=e.currentTarget,a=this.model.tags.get(t.dataset.tag);a&&a.get("writable")&&this.model.tags.setValue(a.id,!a.get("value"))}},initialize:function(){this.scheduleRender=e.debounce(this.render.bind(this),1),this.listenTo(this.model.tags,"reset",this.render),this.listenTo(this.model.tags,"change:value",this.onTagValueChange),t(window).on("resize."+this.idPrefix,this.onResize.bind(this))},destroy:function(){t(window).off("."+this.idPrefix)},serialize:function(){return{idPrefix:this.idPrefix,enlarged:window.innerHeight>=1080,cables:this.serializeCables()}},afterRender:function(){var t=this,a={};t.$("[data-tag]").each(function(){a[this.dataset.tag]=!0}),e.forEach(a,function(e,a){var s=t.model.tags.get(a);s&&t.onTagValueChange(s)})},serializeCables:function(){for(var e=this.model.tags.getValue("program.cables")||2,t=[],a=1;a<=e;++a)t.push({no:a,connectors:this.serializeConnectors(a)});return t},serializeConnectors:function(e){for(var t=this.model.tags.getValue("program.connectors")||3,a=5*(e-1),s=this.serializeCores(),i=[{no:a+1,cores:s,tagSuffix:"status"}],o=1;o<=t;++o)i.push({no:a+1+o,cores:s,tagSuffix:"status"});return i.push({no:a+5,cores:s,tagSuffix:"control"}),i},serializeCores:function(){for(var e=this.model.tags.getValue("program.cores")||7,t=[],a=1;a<=e;++a)t.push({no:a});return t},onResize:function(){this.el.classList.toggle("is-enlarged",window.innerHeight>=1080)},onTagValueChange:function(e){switch(e.id){case"program.message":break;case"program.cables":case"program.connectors":case"program.cores":return this.scheduleRender();case"safetyTest.pe2":return this.togglePe2();case"safetyTest.disabled":return this.toggleSafetyTest();default:var t=e.id.match(g);return t&&this.toggleThroughWireTest(e,t[1],t[2]),this.updateTag(e)}},togglePe2:function(){this.$(".maxos-safetyTest-pe2").toggleClass("hidden",!this.model.tags.getValue("safetyTest.pe2"))},toggleSafetyTest:function(){this.$(".maxos-safetyTest").toggleClass("hidden",!0===this.model.tags.getValue("safetyTest.disabled"))},toggleThroughWireTest:function(e,t,a){var s='[data-cable="'+t+'"][data-core="'+a+'"]',i=e.get("value");this.$(".maxos-link"+s).attr("data-status",i),this.$('.maxos-core[data-tag$="status"]'+s).attr("data-status",i)},updateTag:function(e){if(e){var t=this.$('div[data-tag="'+e.id+'"]');if(t.length){var a=e.get("value"),s=t.attr("data-true")||"maxos-on",i=t.attr("data-false")||"maxos-off",o="string"==typeof a?"maxos-"+a:a?s:i;t.removeClass("maxos-on maxos-off maxos-progress maxos-failure maxos-success "+s+" "+i).addClass(o)}}}})});