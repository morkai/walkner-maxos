// Part of <https://miracle.systems/p/walkner-maxos> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/views/VkbView","../templates/orderSelector"],function(e,r,t,i,n,o,s,d,a){"use strict";return s.extend({template:a,events:{submit:function(){return this.order.cables=parseInt(this.$('input[name="cables"]:checked').val(),10)||0,this.order.connectors=parseInt(this.$('input[name="connectors"]:checked').val(),10)||0,this.order.cores=parseInt(this.$('input[name="cores"]:checked').val(),10)||0,this.order.cables&&this.order.connectors&&this.order.cores&&this.trigger("orderSelected",this.order),!1},"focus #-orderNo":function(e){this.vkb.show(e.currentTarget,this.onVkbValueChange)},"input #-orderNo":function(){this.onVkbValueChange()},"click #-recentOrders > .btn":function(e){this.$id("orderNo").val(e.currentTarget.textContent.trim()),this.onVkbValueChange()}},initialize:function(){this.onVkbValueChange=this.onVkbValueChange.bind(this),this.specialOrderSet=!1,this.vkb=new d},destroy:function(){this.vkb.hide(),this.vkb.remove()},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){this.vkb.render().$el.appendTo("body"),this.$('input[type="radio"]').prop("disabled",!0),this.$(".btn-primary").prop("disabled",!0),this.$id("orderNo").focus(),this.findRecentOrders()},onVkbValueChange:function(){var e=this.$id("orderNo").val().replace(/[^0-9]+/g,"");this.specialOrderSet||"00"!==e||(this.specialOrderSet=!0,e="000000000",this.$id("orderNo").val(e)[0].selectionStart=10),9!==e.length?this.order=null:(this.order=null,this.findOrder(e)),this.toggleInputs()},toggleInputs:function(){var e=this.$('input[type="radio"]').prop("disabled",!0),r=this.$(".btn-primary").prop("disabled",!0);this.order&&(r.prop("disabled",!1),("000000000"===this.$id("orderNo").val()||this.model.auth.changeConfig())&&(e.filter('[name="cables"]').prop("disabled",!1),e.filter('[name="connectors"]').prop("disabled",!1),e.filter('[name="cores"]').prop("disabled",!1)))},findOrder:function(e){var r=this,i=r.$id("orderNo").prop("disabled",!0);o.msg.hide(null,!0),o.msg.loading(),r.vkb.hide();var n=r.ajax({url:"/maxos/order/"+e});n.fail(function(){404===n.status?(o.msg.loaded(),o.msg.show({type:"error",time:2500,text:t("maxos","orderSelector:notFound")})):o.msg.loadingFailed()}),n.done(function(e){o.msg.loaded(),r.order=e,r.$("input:checked").prop("checked",!1),r.$('input[name="cables"][value="'+e.cables+'"]').prop("checked",!0),r.$('input[name="connectors"][value="'+e.connectors+'"]').prop("checked",!0),r.$('input[name="cores"][value="'+e.cores+'"]').prop("checked",!0),r.toggleInputs()}),n.always(function(){var e=i.prop("disabled",!1).focus()[0];e.selectionStart=e.selectionEnd=e.value.length})},findRecentOrders:function(){var e=this.ajax({url:"/maxos/recentOrders"}),r=this.$id("recentOrders");e.done(function(e){r.append(e.map(function(e){return'<div class="btn btn-default">'+e+"</div>"}).join("")),e.length&&r.removeClass("hidden")})}})});