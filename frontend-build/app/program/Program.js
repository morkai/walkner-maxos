// Part of <https://miracle.systems/p/walkner-maxos> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../i18n","../time","../core/Model"],function(t,e,r,n){"use strict";var i={idle:"",running:"warning",failure:"danger",success:"success"};return n.extend({urlRoot:"/program",clientUrlRoot:"#program",topicPrefix:"program",privilegePrefix:"PROGRAM",nlsDomain:"program",labelAttribute:"description",defaults:function(){return{description:"",chamberCount:2,tempController1:3,tempController2:7,stopOnCoverOpen:!1,steps:[],repeatCount:1}},serialize:function(){var t=this.toJSON();return t.className=i[t.status],t.status=e("program","status:"+t.status),t.startedAt=r.format(t.startedAt,"L, LTS"),t.finishedAt&&(t.finishedAt=r.format(t.finishedAt,"L, LTS"),t.elapsedTime=r.toString(this.getElapsedTime()/1e3)),t.reason&&(t.reason=e("program","reason:"+t.reason)),t},isRunning:function(){return"running"===this.get("status")},getDuration:function(){var e=0;return t.forEach(this.get("steps"),function(t){e+=t.duration}),e*(this.get("repeatCount")||1)+(this.get("additionalTime")||0)/6e4},getElapsedTime:function(){return Date.parse(this.get("finishedAt"))-Date.parse(this.get("startedAt"))},getFinishTime:function(){return Date.parse(this.get("startedAt"))+60*this.getDuration()*1e3+(this.get("additionalTime")||0)},getCurrentStep:function(){var t=this.get("steps"),e=this.get("currentStep");return Array.isArray(t)&&t[e%t.length]||null},getCurrentStepStartTime:function(){return Date.parse(this.get("currentStepStartedAt"))},getCurrentStepFinishTime:function(){var t=this.getCurrentStep();if(!t)return 0;var e;if(t.startTemperature){var r=Date.parse(this.get("currentStartTemperatureAt"));e=r||Date.now()}else e=this.getCurrentStepStartTime();return e+60*t.duration*1e3}})});