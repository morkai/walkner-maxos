// Part of <https://miracle.systems/p/walkner-maxos> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/i18n","app/core/views/ListView","app/events/templates/list"],function(e,t,r,a,i){"use strict";return a.extend({template:i,remoteTopics:{"events.saved":"refreshCollection"},serialize:function(){var e=this;return{events:this.collection.map(function(a){var i=a.get("type"),n=e.prepareData(i,a.get("data"));return{severity:a.getSeverityClassName(),time:t.format(a.get("time"),"lll"),user:a.get("user"),type:r("events","TYPE:"+i),text:r("events","TEXT:"+i,r.flatten(n))}})}},refreshCollection:function(e,t){if("function"!=typeof this.options.filter||!Array.isArray(e)||e.some(this.options.filter))return a.prototype.refreshCollection.call(this,e,t)},prepareData:function(e,r){if(r.$prepared)return r;switch(r.$prepared=!0,r.date&&(r.date=t.format(r.date,"YYYY-MM-DD")),r.timestamp&&(r.timestamp=t.format(r.timestamp,"YYYY-MM-DD, HH:mm:ss")),e){case"controller.settingChanged":case"controller.tagValueChanged":r.oldValue=this.formatTagValue(r.oldValue),r.newValue=this.formatTagValue(r.newValue)}return r},formatTagValue:function(e){return null==e?"NULL":(e="object"==typeof e?JSON.stringify(e):String(e),e.substring(0,30)+(e.length>30?"...":""))}})});