// Part of <https://miracle.systems/p/walkner-maxos> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/viewport","app/i18n","app/user","app/core/util/pageActions","app/core/util/bindLoadingMessage","app/core/pages/DetailsPage","app/core/views/ActionFormView","app/users/UserCollection","app/events/EventCollection","app/events/views/EventListView","../Alarm","../views/AlarmDetailsView","app/alarms/templates/detailsPage","i18n!app/nls/alarms","i18n!app/nls/events"],function(e,t,i,n,s,a,o,l,r,p,c,h,u,d){"use strict";return o.extend({template:d,actions:function(){var e=this.model,t=[];return e.get("state")===h.State.ACTIVE&&e.get("stopConditionMode")===h.StopConditionMode.MANUAL&&t.push({label:i.bound("alarms","PAGE_ACTION:ack"),icon:"thumbs-up",href:e.genClientUrl("ack"),privileges:"ALARMS:ACK",callback:function(t){1===t.which&&(l.showDialog({actionKey:"ack",model:e,formActionSeverity:"success"}),t.preventDefault())}}),e.get("state")===h.State.STOPPED?t.push({label:i.bound("alarms","PAGE_ACTION:run"),icon:"play",href:e.genClientUrl("run"),privileges:"ALARMS:MANAGE",callback:function(t){1===t.which&&(l.showDialog({actionKey:"run",model:e}),t.preventDefault())}}):t.push({label:i.bound("alarms","PAGE_ACTION:stop"),icon:"pause",href:e.genClientUrl("stop"),privileges:"ALARMS:MANAGE",callback:function(t){1===t.which&&(l.showDialog({actionKey:"stop",model:e,formActionSeverity:"warning"}),t.preventDefault())}}),t.push(s.edit(e,"ALARMS:MANAGE"),s.delete(e,"ALARMS:MANAGE")),t},initialize:function(){o.prototype.initialize.apply(this,arguments),this.layout=null,this.defineBindings(),this.setView("#"+this.idPrefix+"-details",this.detailsView),this.setView("#"+this.idPrefix+"-events",this.eventsView)},defineModels:function(){o.prototype.defineModels.apply(this,arguments);var e=this.model.genClientUrl()+"?eventsPage=${page}";this.events=a(new p(null,{rqlQuery:{selector:{name:"and",args:[{name:"regex",args:["type","^alarms."]},{name:"eq",args:["data.model._id",this.model.id]}]},sort:{time:-1},limit:20,skip:20*((this.options.eventsPage||1)-1)}}),this),this.events.genPaginationUrlTemplate=function(){return e}},defineViews:function(){this.detailsView=new u({model:{alarm:this.model}}),this.eventsView=new c({collection:this.events})},setUpLayout:function(e){this.layout=e},defineBindings:function(){this.listenTo(this.model,"change:state change:stopConditionMode",function(){this.layout&&this.layout.setActions(this.actions,this)})},load:function(e){return e(this.model.fetch(),this.events.fetch({reset:!0}))}})});