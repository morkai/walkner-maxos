// Part of <https://miracle.systems/p/walkner-maxos> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/viewport","app/i18n","app/core/Page","../Alarm","../views/AlarmFormView","app/users/UsersCollection","i18n!app/nls/alarms","i18n!app/nls/users"],function(e,r,s,a,i,t,n){"use strict";var o=a.extend({breadcrumbs:function(){return[{label:s.bound("alarms","BREADCRUMBS_BROWSE"),href:"#alarms"},{label:this.alarm.get("name"),href:this.alarm.genUrl()},{label:s.bound("alarms","BREADCRUMBS_EDIT_FORM")}]}});return o.prototype.initialize=function(){this.defineModels(),this.defineViews()},o.prototype.render=function(){var s=r.useLayout("page").setId("alarms-edit-form");s.setView(".bd",this.alarmFormView);var a=this,i=this.alarm.fetch(),t=this.users.fetch({reset:!0}),n=this.broker.subscribe("router.executing",function(){a.alarm.off(),a.users.off(),i.abort(),t.abort()}).setLimit(1);e.when(i,t).done(function(){n.cancel(),s.setBreadcrumbs(a.breadcrumbs),a.alarmFormView.render()})},o.prototype.defineModels=function(){this.alarm=new i({_id:this.options.alarmId}),this.users=new n(null,{rqlQuery:"select(login,email,mobile)&sort(+login)"}),this.alarm.on("request",r.msg.loading),this.alarm.on("sync",r.msg.loaded),this.alarm.on("error",function(){r.msg.loadingFailed(s("alarms","MSG_LOADING_ALARM_FAILED"))}),this.users.on("request",r.msg.loading),this.users.on("sync",r.msg.loaded),this.users.on("error",function(){r.msg.loadingFailed(s("users","MSG_LOADING_USERS_FAILED"))})},o.prototype.defineViews=function(){this.alarmFormView=new t({model:{alarm:this.alarm,users:this.users},formMethod:"PUT",formAction:"/alarms/"+this.alarm.id,formActionText:s("alarms","FORM_ACTION_EDIT"),genericFailureText:s("alarms","FORM_ERROR_EDIT_FAILED"),failureText:s.bind(null,"alarms","FORM_ERROR_EDIT_FAILED_REASON"),requirePassword:!1})},o});