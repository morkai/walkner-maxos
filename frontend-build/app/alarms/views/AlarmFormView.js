// Part of <https://miracle.systems/p/walkner-maxos> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/core/views/FormView","./MessageActionFormView","./SeverityActionFormView","./CallActionFormView","app/alarms/templates/form","app/alarms/templates/actionControls"],function(t,e,i,o,n,r,a,s,c){"use strict";var l={debug:"btn-default",info:"btn-info",success:"btn-success",warning:"btn-warning",error:"btn-danger"};return o.extend({template:s,events:t.extend({},o.prototype.events,{'change input[name="stopConditionMode"]':function(){this.toggleStopConditionState()},"click .alarms-form-actions-add":function(){this.addAction(this.$id("actions-type").val())},"click .alarms-form-action-controls-remove":function(t){this.removeAction(this.$(t.target).closest(".alarms-form-action"))},"click .alarms-form-action-controls-up":function(t){this.moveActionUp(this.$(t.target).closest(".alarms-form-action"))},"click .alarms-form-action-controls-down":function(t){this.moveActionDown(this.$(t.target).closest(".alarms-form-action"))},"click .severity":function(t){var e=this.$(t.target);return this.changeActionSeverity(e.closest(".alarms-form-action"),e.closest(".severity").attr("data-severity"),!0),!1}}),initialize:function(){o.prototype.initialize.apply(this,arguments),this.lastActionIndex=0,this.scheduleResizeArrow=t.debounce(this.resizeArrow.bind(this),100),e(window).on("resize.alarms",this.scheduleResizeArrow)},destroy:function(){e(window).off(".alarms")},afterRender:function(){for(var t=this.model.get("startActions"),e=0;e<t.length;++e)this.addAction(t[e].type,t[e]);o.prototype.afterRender.call(this),this.toggleStopConditionState(),this.checkActionsValidity(),this.resizeArrow()},toggleStopConditionState:function(){this.$id("stopCondition").attr("disabled","specified"!==this.$('input[name="stopConditionMode"]:checked').val())},checkActionsValidity:function(){this.$id("actions-type")[0].setCustomValidity(this.$(".alarms-form-action").length?"":i("alarms","FORM:ERROR:noActions"))},addAction:function(t,e){function i(){o.on("resize",l),l()}var o=null,s=++this.lastActionIndex;switch(t){case"sms":case"email":o=new n({actionType:t,extraUserProperty:"sms"===t?"mobile":"email",index:s,model:e});break;case"call":o=new a({actionType:t,index:s,model:e});break;case"severity":o=new r({index:s});break;default:return}this.insertView(".alarms-form-actions",o),o.render(),o.$el.append(c()),o.$el.find(".alarms-form-action-controls-severity").dropdown(),this.changeActionSeverity(o.$el,e?e.severity:"warning");var l=this.resizeArrow.bind(this);e?i():(l(),o.$el.hide().fadeIn(i)),this.checkActionsValidity()},resizeArrow:function(){var t=this.$(".alarms-form-actions-arrow"),e=this.$(".alarms-form-actions");t.height(e.outerHeight(!0)+20),this.$(".alarms-form-actions-control-group").toggleClass("alarms-form-actions-empty",0===e.children().length)},changeActionSeverity:function(t,e,i){var o=t.find(".alarms-form-action-severity"),n=o.val(),r=t.find(".alarms-form-action-controls-severity");r.removeClass(l[n]),r.addClass(l[e]),i&&r.dropdown("toggle"),o.val(e)},removeAction:function(t){var e=this,i=this.getViews({el:t[0]}).first().value();t.find(".alarms-form-action-controls-remove").attr("disabled",!0),t.fadeOut(function(){i.remove(),e.resizeArrow(),e.checkActionsValidity()})},moveActionUp:function(t){var e=this.$(".alarms-form-action");if(1!==e.length){var i=this,o=t.find(".alarms-form-action-controls-up");o.attr("disabled",!0),t.fadeOut("fast",function(){var n=t.prev();0===n.length?t.insertAfter(e.last()):t.insertBefore(n),o.attr("disabled",!1),t.fadeIn("fast",i.resizeArrow.bind(i))})}},moveActionDown:function(t){var e=this.$(".alarms-form-action");if(1!==e.length){var i=this,o=t.find(".alarms-form-action-controls-up");o.attr("disabled",!0),t.fadeOut("fast",function(){var n=t.next();0===n.length?t.insertBefore(e.first()):t.insertAfter(n),o.attr("disabled",!1),t.fadeIn("fast",i.resizeArrow.bind(i))})}},handleFailure:function(t){var e=t.responseJSON.error||{};i.has("alarms","FORM:ERROR:"+e.code)?this.showErrorMessage(i("alarms","FORM:ERROR:"+e.code,e)):o.prototype.handleFailure.apply(this,arguments)}})});